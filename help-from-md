#!/bin/bash

if [[ "$#" != 2 ]]; then
    echo "Usage: $0 MD_FILE HELP_FILE.h"
    exit 1
fi

mdfile="$1"
helpfile="$2"
newfile="$helpfile.new"
findfile="${helpfile/./\\.}"

sed '1,/^\[comment\].*'"$findfile"'/d' <"$mdfile" | \
    sed '1,/^```/d' | \
    sed '/^```/,$d' | \
    sed 's/"/\\"/g' | \
    sed 's/^/  rprintf(F,"/' | \
    sed 's/$/\\n");/' >"$newfile"

if [[ ! -s "$newfile" ]]; then
    rm "$newfile"
    echo "Discarding empty output for $helpfile file from $mdfile"
    exit 1
fi

(cat <<EOT
/* DO NOT EDIT THIS FILE!  It is auto-generated from the option list in $mdfile! */
 
EOT
cat "$newfile"
) >"$helpfile"
rm "$newfile"
