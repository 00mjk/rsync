#!/bin/sh -e
# This configure script ensures that the configure.sh script exists, and
# if not, it tries to fetch rsync's generated files or build them.  We
# then transfer control to the configure.sh script to do the real work.

dir=`dirname $0`

# Support automatic switching to build/$BRANCH subdirs.  It's also good
# to put packaging/make somewhere early in your $PATH if you use this!
if test "$dir" = '.' -a ! -f Makefile -a -d build/master -a -d .git; then
    builddir=build/`git rev-parse --abbrev-ref HEAD | tr / %`
    test -d "$builddir" || mkdir "$builddir"
    cd "$builddir" || exit 1
    dir=../..
fi

if test ! -f configure.sh; then
    if ! "$dir/prepare-source" build; then
	echo 'Failed to build configure.sh and/or config.h.in -- giving up.' >&2
	rm -f configure.sh
	exit 1
    fi
fi

exec ./configure.sh --srcdir="$dir" "${@}"
